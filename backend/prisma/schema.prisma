generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  HR
  MANAGER
  EMPLOYEE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EmployeeStatus {
  ONBOARDING
  ACTIVE
  ON_PROBATION
  CONFIRMED
  NOTICE_PERIOD
  RESIGNED
  TERMINATED
  INACTIVE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
}

enum DocumentType {
  PROFILE_PHOTO
  GOVERNMENT_ID
  TAX_ID
  RESUME
  BANK_PROOF
  EDUCATION
  EXPERIENCE
  OFFER_LETTER
  OTHER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  MISSING
}

enum AttendanceType {
  PRESENT
  ABSENT
  HALF_DAY
  LEAVE
  HOLIDAY
  WEEK_OFF
}

enum LeaveType {
  SICK_LEAVE
  CASUAL_LEAVE
  PAID_LEAVE
  UNPAID_LEAVE
  MATERNITY_LEAVE
  PATERNITY_LEAVE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayrollStatus {
  DRAFT
  PROCESSED
  PAID
}

enum ProbationDecision {
  CONFIRM
  EXTEND
  TERMINATE
}

enum ProbationStatus {
  IN_PROGRESS
  CONFIRMED
  EXTENDED
  TERMINATED
}

enum GoalStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaxRegime {
  OLD
  NEW
}

enum TaxDeclarationStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  role              Role      @default(EMPLOYEE)
  isActive          Boolean   @default(true)
  emailVerified     Boolean   @default(false)
  failedLoginCount  Int       @default(0)
  lockedUntil       DateTime?
  passwordChangedAt DateTime?
  lastLoginAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?
  
  employee          Employee?
  passwordHistory   PasswordHistory[]
  sessions          Session[]
  auditLogs         AuditLog[]
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  resource  String
  details   String?  // JSON string
  ipAddress String?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id])
}

model Employee {
  id                  String    @id @default(uuid())
  userId              String    @unique
  employeeCode        String    @unique
  firstName           String
  lastName            String
  email               String    @unique
  phoneNumber         String?
  dateOfBirth         DateTime?
  gender              Gender?
  address             String?
  city                String?
  state               String?
  country             String    @default("US")
  zipCode             String?
  
  departmentId        String?
  designationId       String?
  reportingManagerId  String?
  
  joiningDate         DateTime
  confirmationDate    DateTime?
  exitDate            DateTime?
  employmentType      EmploymentType @default(FULL_TIME)
  
  status              EmployeeStatus @default(ONBOARDING)
  probationEndDate    DateTime?
  
  emergencyContactName   String?
  emergencyContactPhone  String?
  emergencyContactRelation String?
  
  bankAccountNumber   String?
  bankName            String?
  bankIFSC            String?
  
  taxId               String?  // SSN/PAN encrypted
  governmentId        String?  // Aadhaar/Passport encrypted
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deletedAt           DateTime?
  createdBy           String?
  updatedBy           String?
  
  user                User      @relation(fields: [userId], references: [id])
  department          Department? @relation(fields: [departmentId], references: [id])
  designation         Designation? @relation(fields: [designationId], references: [id])
  reportingManager    Employee?  @relation("ManagerEmployee", fields: [reportingManagerId], references: [id])
  subordinates        Employee[] @relation("ManagerEmployee")
  
  documents           EmployeeDocument[]
  attendance          Attendance[]
  leaves              Leave[]
  payroll             PayrollRecord[]
  salaryStructure     SalaryStructure?
  performanceReviews  PerformanceReview[]
  goals               Goal[]
  taxDeclarations     TaxDeclaration[]
  probationReview     ProbationReview?
}

model Department {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  employees   Employee[]
  shifts      Shift[]
}

model Designation {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  employees   Employee[]
}

model EmployeeDocument {
  id             String   @id @default(uuid())
  employeeId     String
  documentType   DocumentType
  fileName       String
  fileUrl        String   // S3 URL
  fileSize       Int
  mimeType       String
  status         DocumentStatus @default(PENDING)
  uploadedAt     DateTime @default(now())
  reviewedAt     DateTime?
  reviewedBy     String?
  comments       String?
  
  employee       Employee @relation(fields: [employeeId], references: [id])
}

model Attendance {
  id              String   @id @default(uuid())
  employeeId      String
  date            DateTime @db.Date
  punchIn         DateTime?
  punchOut        DateTime?
  workHours       Float?
  attendanceType  AttendanceType @default(ABSENT)
  isLate          Boolean  @default(false)
  isEarlyDeparture Boolean @default(false)
  remarks         String?
  ipAddress       String?
  location        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  @@unique([employeeId, date])
  @@index([employeeId, date])
}

model Shift {
  id          String   @id @default(uuid())
  name        String
  startTime   String   // HH:mm format
  endTime     String
  workHours   Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  departments Department[]
}

model Leave {
  id              String      @id @default(uuid())
  employeeId      String
  leaveType       LeaveType
  startDate       DateTime    @db.Date
  endDate         DateTime    @db.Date
  totalDays       Float
  reason          String
  status          LeaveStatus @default(PENDING)
  appliedAt       DateTime    @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  employee        Employee    @relation(fields: [employeeId], references: [id])
  
  @@index([employeeId, status])
}

model LeaveBalance {
  id          String   @id @default(uuid())
  employeeId  String
  year        Int
  leaveType   LeaveType
  allocated   Float
  used        Float    @default(0)
  balance     Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([employeeId, year, leaveType])
}

model SalaryStructure {
  id            String   @id @default(uuid())
  employeeId    String   @unique
  ctc           Float
  basicSalary   Float
  hra           Float
  specialAllowance Float
  pfEmployer    Float
  pfEmployee    Float
  professionalTax Float
  effectiveFrom DateTime @db.Date
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String
  
  employee      Employee @relation(fields: [employeeId], references: [id])
}

model PayrollRecord {
  id                String   @id @default(uuid())
  employeeId        String
  month             Int
  year              Int
  basicSalary       Float
  hra               Float
  specialAllowance  Float
  bonus             Float    @default(0)
  grossSalary       Float
  pfEmployee        Float
  pfEmployer        Float
  professionalTax   Float
  tds               Float
  otherDeductions   Float    @default(0)
  netSalary         Float
  status            PayrollStatus @default(DRAFT)
  processedAt       DateTime?
  processedBy       String?
  paymentDate       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  employee          Employee @relation(fields: [employeeId], references: [id])
  payslip           Payslip?
  
  @@unique([employeeId, month, year])
  @@index([month, year, status])
}

model Payslip {
  id            String        @id @default(uuid())
  payrollRecordId String      @unique
  pdfUrl        String        // S3 URL
  generatedAt   DateTime      @default(now())
  
  payrollRecord PayrollRecord @relation(fields: [payrollRecordId], references: [id])
}

model ProbationReview {
  id                String   @id @default(uuid())
  employeeId        String   @unique
  probationEndDate  DateTime @db.Date
  managerRecommendation ProbationDecision?
  managerComments   String?
  managerSubmittedAt DateTime?
  hrDecision        ProbationDecision?
  hrComments        String?
  hrSubmittedAt     DateTime?
  confirmationDate  DateTime? @db.Date
  confirmationLetterUrl String?
  status            ProbationStatus @default(IN_PROGRESS)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  employee          Employee @relation(fields: [employeeId], references: [id])
}

model Goal {
  id          String   @id @default(uuid())
  employeeId  String
  title       String
  description String
  quarter     Int
  year        Int
  targetDate  DateTime @db.Date
  status      GoalStatus @default(IN_PROGRESS)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  reviews     PerformanceReview[]
}

model PerformanceReview {
  id          String   @id @default(uuid())
  employeeId  String
  goalId      String?
  reviewerId  String
  quarter     Int
  year        Int
  rating      Int      // 1-5
  feedback    String?
  reviewDate  DateTime @db.Date
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employee    Employee @relation(fields: [employeeId], references: [id])
  goal        Goal?    @relation(fields: [goalId], references: [id])
}

model TaxDeclaration {
  id              String   @id @default(uuid())
  employeeId      String
  financialYear   String   // "2024-25"
  regime          TaxRegime @default(OLD)
  section80C      Float    @default(0)
  section80D      Float    @default(0)
  section80G      Float    @default(0)
  hraExemption    Float    @default(0)
  homeLoanInterest Float   @default(0)
  otherDeductions Float    @default(0)
  status          TaxDeclarationStatus @default(DRAFT)
  submittedAt     DateTime?
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  employee        Employee @relation(fields: [employeeId], references: [id])
  proofs          TaxProof[]
  
  @@unique([employeeId, financialYear])
}

model TaxProof {
  id                String   @id @default(uuid())
  taxDeclarationId  String
  category          String   // "80C", "80D", etc.
  amount            Float
  proofUrl          String   // S3 URL
  uploadedAt        DateTime @default(now())
  
  taxDeclaration    TaxDeclaration @relation(fields: [taxDeclarationId], references: [id])
}
